<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Elección de Destinos</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<h1>Elige tu destino</h1>

<label for="user_id">Tu ID:</label>
<input type="text" id="user_id" placeholder="Introduce tu ID" />

<label for="destino">Destino:</label>
<select id="destino">
  <option value="">Selecciona un destino</option>
  <option value="Madrid">Madrid</option>
  <option value="Barcelona">Barcelona</option>
  <!-- Añade aquí todas las provincias + Ceuta y Melilla -->
</select>

<button id="guardar">Guardar Preferencia</button>

<h2>Participantes totales: <span id="contador">0</span></h2>

<h2>Ranking por destino</h2>
<div id="ranking"></div>

<script>
  // Configura tu URL y KEY de Supabase
  const supabaseUrl = 'https://oqzpnivpfnpoqeuewwza.supabase.co'
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9xenBuaXZwZm5wb3FldWV3d3phIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyNzkxNzAsImV4cCI6MjA2ODg1NTE3MH0.bFmCIxSRadItouzsl9KmjisCLlk8dms8KljA1vPDrJo'
  const supabase = supabase.createClient(supabaseUrl, supabaseKey)

  const destinos = ["Madrid", "Barcelona", "Valencia", "Sevilla", "Zaragoza", "Málaga", "Murcia", "Palma", "Las Palmas", "Bilbao", "Alicante", "Córdoba", "Valladolid", "Vigo", "Gijón", "L'Hospitalet", "La Coruña", "Granada", "Vitoria", "Elche", "Oviedo", "Badalona", "Cartagena", "Terrassa", "Jerez", "Sabadell", "Móstoles", "Santa Cruz de Tenerife", "Pamplona", "Alcalá de Henares", "Fuenlabrada", "Almería", "San Sebastián", "Getafe", "Burgos", "Santander", "Castellón", "Albacete", "Logroño", "Salamanca", "Huelva", "Marbella", "Lleida", "Tarragona", "León", "Cádiz", "Torrejón de Ardoz", "Mataró", "Dos Hermanas", "Ceuta", "Melilla"]

  // Rellenar select con destinos (por si quieres añadir más fácil)
  const selectDestino = document.getElementById('destino')
  destinos.forEach(d => {
    const option = document.createElement('option')
    option.value = d
    option.textContent = d
    selectDestino.appendChild(option)
  })

  document.getElementById('guardar').onclick = async () => {
    const id_persona = document.getElementById('user_id').value.trim()
    const destino_elegido = document.getElementById('destino').value

    if (!id_persona || !destino_elegido) {
      alert('Introduce tu ID y selecciona un destino')
      return
    }

    // Insertar en tabla preferencias
    const { data, error } = await supabase
      .from('preferencias')
      .insert([{ id_persona, destino_elegido }])

    if (error) {
      alert('Error guardando preferencia: ' + error.message)
    } else {
      alert('Preferencia guardada correctamente')
      cargarRanking()
      cargarContador()
    }
  }

  async function cargarContador() {
    const { count, error } = await supabase
      .from('preferencias')
      .select('*', { count: 'exact', head: true })
    if (!error) {
      document.getElementById('contador').textContent = count
    }
  }

  async function cargarRanking() {
    // Ejemplo: obtener ranking por destino Madrid ordenado por nota descendente
    // Necesitarás hacer un join entre preferencias e id_persona en tabla notas para obtener nota

    const destino = document.getElementById('destino').value || 'Madrid'

    const { data, error } = await supabase
      .from('preferencias')
      .select(
        id_persona,
        destino_elegido,
        personas!inner(ID, Nombre, Nota)
      )
      .eq('destino_elegido', destino)
      .order('personas.Nota', { ascending: false })

    const rankingDiv = document.getElementById('ranking')
    if (error) {
      rankingDiv.textContent = 'Error al cargar ranking: ' + error.message
      return
    }
    if (!data.length) {
      rankingDiv.textContent = 'No hay participantes para este destino.'
      return
    }

    let html = '<ol>'
    data.forEach(item => {
      html += <li>${item.personas.Nombre} (Nota: ${item.personas.Nota})</li>
    })
    html += '</ol>'
    rankingDiv.innerHTML = html
  }

  // Cargar contador y ranking inicial
  cargarContador()
  cargarRanking()
</script>

</body>
</html>
