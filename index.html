<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Elección de Destinos</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }
    label, input, select, button {
      display: block;
      margin: 10px 0;
      width: 100%;
    }
    ol { padding-left: 20px; }
    #ranking, #busqueda-resultados { margin-top: 20px; }
  </style>
</head>
<body>

<h1>Elige tu destino</h1>

<label for="user_id">Tu ID:</label>
<input type="text" id="user_id" placeholder="Introduce tu ID" />

<label for="destino">Destino:</label>
<select id="destino">
  <option value="">Selecciona un destino</option>
</select>

<button id="guardar">Guardar Preferencia</button>

<h2>Participantes totales: <span id="contador">0</span></h2>

<h2>Ranking por destino</h2>
<div id="ranking"></div>

<h2>Buscar participante por nombre</h2>
<input type="text" id="busqueda" placeholder="Escribe un nombre..." />
<div id="busqueda-resultados"></div>

<script>
  const supabase = supabase.createClient(
    'https://oqzpnivpfnpoqeuewwza.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9xenBuaXZwZm5wb3FldWV3d3phIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyNzkxNzAsImV4cCI6MjA2ODg1NTE3MH0.bFmCIxSRadItouzsl9KmjisCLlk8dms8KljA1vPDrJo'
  )

  const destinos = [/* lista completa de provincias */ "Madrid", "Barcelona", "Valencia", "Sevilla", "Zaragoza", "Málaga", "Murcia", "Palma", "Las Palmas", "Bilbao", "Alicante", "Córdoba", "Valladolid", "Vigo", "Gijón", "L'Hospitalet", "La Coruña", "Granada", "Vitoria", "Elche", "Oviedo", "Badalona", "Cartagena", "Terrassa", "Jerez", "Sabadell", "Móstoles", "Santa Cruz de Tenerife", "Pamplona", "Alcalá de Henares", "Fuenlabrada", "Almería", "San Sebastián", "Getafe", "Burgos", "Santander", "Castellón", "Albacete", "Logroño", "Salamanca", "Huelva", "Marbella", "Lleida", "Tarragona", "León", "Cádiz", "Torrejón de Ardoz", "Mataró", "Dos Hermanas", "Ceuta", "Melilla"];

  const selectDestino = document.getElementById('destino');
  destinos.forEach(d => {
    const option = document.createElement('option');
    option.value = d;
    option.textContent = d;
    selectDestino.appendChild(option);
  });

  document.getElementById('guardar').onclick = async () => {
    const id_persona = document.getElementById('user_id').value.trim();
    const destino_elegido = document.getElementById('destino').value;
    if (!id_persona || !destino_elegido) return alert('Rellena todos los campos');

    const { error } = await supabase.from('preferencias').insert([{ id_persona, destino_elegido }]);
    if (error) return alert('Error: ' + error.message);

    alert('Preferencia guardada');
    cargarRanking();
    cargarContador();
  }

  async function cargarContador() {
    const { count } = await supabase.from('preferencias').select('*', { count: 'exact', head: true });
    document.getElementById('contador').textContent = count ?? '0';
  }

  async function cargarRanking() {
    const destino = document.getElementById('destino').value || 'Madrid';
    const { data, error } = await supabase
      .from('preferencias')
      .select('id_persona, destino_elegido, personas!inner(ID, Nombre, Nota)')
      .eq('destino_elegido', destino)
      .order('personas.Nota', { ascending: false });

    const rankingDiv = document.getElementById('ranking');
    if (error || !data.length) {
      rankingDiv.textContent = 'No hay participantes o error.';
      return;
    }

    rankingDiv.innerHTML = '<ol>' + data.map(p => `<li>${p.personas.Nombre} (Nota: ${p.personas.Nota})</li>`).join('') + '</ol>';
  }

  document.getElementById('busqueda').addEventListener('input', async e => {
    const texto = e.target.value.toLowerCase();
    if (!texto) return document.getElementById('busqueda-resultados').innerHTML = '';

    const { data, error } = await supabase
      .from('personas')
      .select('Nombre, Nota')
      .ilike('Nombre', `%${texto}%`);

    const div = document.getElementById('busqueda-resultados');
    if (error || !data.length) {
      div.textContent = 'Sin resultados';
      return;
    }

    div.innerHTML = '<ul>' + data.map(p => `<li>${p.Nombre} (Nota: ${p.Nota})</li>`).join('') + '</ul>';
  });

  cargarContador();
  cargarRanking();
</script>

</body>
</html>
